{% import "macros/macros.html" as post_macros %}

<!DOCTYPE html>
<html lang="en" class="dark light">
<style>
    span {
        font-size: small;
    }

    /* Mobile-first responsive design */
    @media (max-width: 768px) {
        details summary {
            font-size: 1rem;
            padding: 6px;
        }

        .pdf-container iframe {
            height: 70vh;
        }
    }

    /* PWA-specific styles */
    @media (display-mode: standalone) {

        /* Hide browser UI elements when in PWA mode */
        .browser-only {
            display: none;
        }

        /* Add safe area for notched devices */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
    }

    /* Install banner animations */
    #install-banner { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp {
      from { transform: translate(-50%, 100%); opacity:0; }
      to { transform: translate(-50%, 0); opacity:1; }
    }
</style>
{% include "partials/header.html" %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        try {
            if (window.posthog) {
                //   console.debug('posthog loaded, distinct_id=', posthog.get_distinct_id && posthog.get_distinct_id());
                const sessionData = sessionStorage.getItem('user_session');
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    if (session.srn) {
                        // Only send PII if user has not opted out
                        if (window.isPIITrackingAllowed && window.isPIITrackingAllowed()) {
                            posthog.identify(session.srn);
                            posthog.register({
                                srn: session.srn,
                                name: session.profile?.name || null
                            });
                        }
                    }
                }
                //   try { posthog.capture('_debug_client_loaded'); }
                //   catch (e) { console.error('posthog.capture failed', e); }
            }
            else {
                console.warn('posthog not found on page (init script missing or blocked)');
            }
        } catch (e) {
            console.error('posthog identify failed', e);
        }
    });
</script>

<body>
    <div class="left-content">
        {% block left_content %}
        {% endblock left_content %}
    </div>



    <div class="content">
        {% include "partials/nav.html" %}

        {# Post page is the default #}
        {% block main_content %}
        Nothing here?!
        {% endblock main_content %}

        {% if page.extra.comment is defined %}
        {% set show_comment = page.extra.comment %}
        {% else %}
        {% set show_comment = false %}
        {% endif %}

        {% if show_comment %}
        <div class="giscus"></div>
        {% include "_giscus_script.html" %}
        {% endif %}
        <footer>
            <div style="margin-bottom: 10px;">
                <a href="javascript:void(0)" onclick="showAnalyticsSettings()"
                    style=" text-decoration: underline;">Privacy Settings</a> |
                <a href="/privacy-policy" style="text-decoration: underline; ">Privacy Policy</a> |
                <a href="/terms-of-service" style="text-decoration: underline; ">Terms of Service</a>
            </div>
            <p>Built with ‚ù§Ô∏è using <a href="https://getzola.org/"
                        style="text-decoration: underline;">Zola</a> and <a
                        href="https://www.getzola.org/themes/apollo/"
                        style="text-decoration: underline;">Apollo</a></p>
            <span>&COPY; 2025 Anon</span>
        </footer>
    </div>

    <div class="right-content">
        {% block right_content %}
        {% endblock right_content %}
    </div>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Append a version query to bypass HTTP caches of sw.js
                const swVersion = '{{ config.extra.sw_version | default(value="0") }}';
                navigator.serviceWorker.register(`/sw.js?v=${swVersion}`, { scope: '/' })
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });

                // Ask the service worker to refresh cached assets on every page load.
                // This posts a message to the active controller (or waits until ready).
                try {
                    if (navigator.serviceWorker.controller) {
                        // postMessage returns undefined; don't log its return value.
                        navigator.serviceWorker.controller.postMessage({ type: 'REFRESH_ON_LOAD' });
                        console.log('REFRESH_ON_LOAD message posted to active service worker');
                    } else {
                        // Wait until the service worker is ready (registration available)
                        navigator.serviceWorker.ready.then(() => {
                            if (navigator.serviceWorker.controller) {
                                navigator.serviceWorker.controller.postMessage({ type: 'REFRESH_ON_LOAD' });
                                console.log('REFRESH_ON_LOAD message posted to service worker (on ready)');
                            } else {
                                console.log('No active service worker controller to receive REFRESH_ON_LOAD');
                            }
                        }).catch((e) => console.warn('serviceWorker.ready failed', e));
                    }
                } catch (e) { console.warn('REFRESH_ON_LOAD postMessage failed', e); }
            });
        }

        // Listen for messages from the service worker and log them to the page console
        if (navigator.serviceWorker) {
            navigator.serviceWorker.addEventListener('message', (evt) => {
                try {
                    const d = evt.data || {};
                    console.log('ServiceWorker -> page message:', d);
                    if (d && d.type === 'CACHE_REFRESHED') {
                        console.log(`[SW] CACHE_REFRESHED: refreshed ${d.refreshed}/${d.total} assets`);
                        // show a small non-blocking toast
                        // try {
                        //     const t = document.createElement('div');
                        //     t.textContent = `Updated ${d.refreshed}/${d.total} cached assets`;
                        //     t.style.position = 'fixed';
                        //     t.style.bottom = '12px';
                        //     t.style.right = '12px';
                        //     t.style.background = 'rgba(0,0,0,0.8)';
                        //     t.style.color = '#fff';
                        //     t.style.padding = '8px 12px';
                        //     t.style.borderRadius = '6px';
                        //     t.style.zIndex = 9999;
                        //     t.style.fontSize = '0.95rem';
                        //     document.body.appendChild(t);
                        //     setTimeout(() => { t.style.transition = 'opacity 300ms'; t.style.opacity = '0'; setTimeout(()=>t.remove(), 350); }, 3000);
                        // } catch (e) { /* ignore UI errors */ }
                    }
                } catch (e) { console.warn('SW message handler error', e); }
            });
        }

        // PWA Install Prompt
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;

            // Show install button/banner
            showInstallPrompt();
        });

        function showInstallPrompt() {
            // Create install banner
            const installBanner = document.createElement('div');
            installBanner.id = 'install-banner';
            installBanner.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #4a90e2;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 1000;
                    font-family: Arial, sans-serif;
                    text-align: center;
                    max-width: 300px;
                ">
                    <div style="margin-bottom: 10px;">üì± Install PESU BCA App</div>
                    <button id="install-button" style="
                        background: white;
                        
                        border: none;
                        padding: 8px 16px;
                        border-radius: 5px;
                        margin-right: 10px;
                        cursor: pointer;
                    ">Install</button>
                    <button id="dismiss-button" style="
                        background: transparent;
                        color: white;
                        border: 1px solid white;
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                    ">Later</button>
                </div>
            `;

            document.body.appendChild(installBanner);

            // Install button click
            let _pwaInteracted = false;
            const _autoDismiss = setTimeout(() => {
                if (!_pwaInteracted && installBanner.parentNode) {
                    installBanner.parentNode.removeChild(installBanner);
                }
            }, 3000);
            document.getElementById('install-button').addEventListener('click', () => {
                _pwaInteracted = true;
                clearTimeout(_autoDismiss);
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        }
                        deferredPrompt = null;
                        document.body.removeChild(installBanner);
                    });
                }
            });

            // Dismiss button click
            document.getElementById('dismiss-button').addEventListener('click', () => {
                _pwaInteracted = true;
                clearTimeout(_autoDismiss);
                document.body.removeChild(installBanner);
            });
        }

        // Handle app installation - Show custom notification
        window.addEventListener('appinstalled', (evt) => {
            // Show custom success notification
            showSuccessNotification();

            // Track installation with PostHog
            if (window.posthog) {
                posthog.capture('pwa_installed');
            }

            // Remove install banner if it still exists
            const installBanner = document.getElementById('install-banner');
            if (installBanner) {
                document.body.removeChild(installBanner);
            }
        });

        function showSuccessNotification() {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #10b981;
                    color: white;
                    padding: 20px 30px;
                    border-radius: 10px;
                    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                    text-align: center;
                    max-width: 350px;
                    animation: slideDown 0.5s ease-out;
                ">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üéâ</div>
                    <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 5px;">
                        App Installed Successfully!
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">
                        You can now access PESU BCA from your home screen
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.5s ease-in';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 500);
            }, 4000);
        }

        // Add animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    transform: translate(-50%, -100%);
                    opacity: 0;
                }
                to {
                    transform: translate(-50%, 0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- Initialize Client-Side Router for smooth navigation -->
    <script type="module">
        import Router from '/js/router/index.js?v={{ config.extra.sw_version }}';
        import { setupRouter } from '/js/router/handlers.js?v={{ config.extra.sw_version }}';

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initRouter);
        } else {
            initRouter();
        }

        function initRouter() {
            try {
                const router = setupRouter(Router);
                window.appRouter = router;
                console.log('[CSR Router] Initialized successfully');
            } catch (error) {
                console.warn('[CSR Router] Failed to initialize:', error);
                // Fall back to traditional navigation
            }
        }
    </script>
</body>

</html>