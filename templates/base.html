{% import "macros/macros.html" as post_macros %}

<!DOCTYPE html>
<html lang="en" class="dark light">
    <style>
        span {
            font-size: small;
        }

        mark {
            background-color: tomato;
            padding: 0.1em;
            border-radius: 0.125em;
        }

        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            details summary {
                font-size: 1rem;
                padding: 6px;
            }
            
            .pdf-container iframe {
                height: 70vh;
            }
        }

        /* PWA-specific styles */
        @media (display-mode: standalone) {
            /* Hide browser UI elements when in PWA mode */
            .browser-only {
                display: none;
            }
            
            /* Add safe area for notched devices */
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Install banner animations */
        #install-banner {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
    </style>
    {% include "partials/header.html" %}

    <body>
        <div class="left-content">
            {% block left_content %}
            {% endblock left_content %}
        </div>

        <div class="content">
            {% include "partials/nav.html" %}

            {# Post page is the default #}
            {% block main_content %}
                Nothing here?!
            {% endblock main_content %}

            {% if page.extra.comment is defined %}
                {% set show_comment = page.extra.comment %}
            {% else %}
                {% set show_comment = false %}
            {% endif %}

            {% if show_comment %}
                <div class="giscus"></div>
                {% include "_giscus_script.html" %}
            {% endif %}
            <footer>
                <div style="margin-bottom: 10px;">
                    <a href="javascript:void(0)" onclick="showAnalyticsSettings()" style="color: #4a90e2; text-decoration: none; margin: 0 10px;">
                        Privacy Settings
                    </a>
                </div>
                <p>Built with ‚ù§Ô∏è using <mark><a href="https://getzola.org/" style="text-decoration: underline;">Zola</a></mark> and <mark><a href="https://www.getzola.org/themes/apollo/" style="text-decoration: underline;">Apollo</a></mark></p>
                <span>&COPY; 2025 Lalith B Seervi</span>
            </footer>
        </div>

        <div class="right-content">
            {% block right_content %}
            {% endblock right_content %}
        </div>
        <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            
            // Show install button/banner
            showInstallPrompt();
        });

        function showInstallPrompt() {
            // Create install banner
            const installBanner = document.createElement('div');
            installBanner.id = 'install-banner';
            installBanner.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #4a90e2;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 1000;
                    font-family: Arial, sans-serif;
                    text-align: center;
                    max-width: 300px;
                ">
                    <div style="margin-bottom: 10px;">üì± Install PESU BCA App</div>
                    <button id="install-button" style="
                        background: white;
                        color: #4a90e2;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 5px;
                        margin-right: 10px;
                        cursor: pointer;
                    ">Install</button>
                    <button id="dismiss-button" style="
                        background: transparent;
                        color: white;
                        border: 1px solid white;
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                    ">Later</button>
                </div>
            `;
            
            document.body.appendChild(installBanner);
            
            // Install button click
            document.getElementById('install-button').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        }
                        deferredPrompt = null;
                        document.body.removeChild(installBanner);
                    });
                }
            });
            
            // Dismiss button click
            document.getElementById('dismiss-button').addEventListener('click', () => {
                document.body.removeChild(installBanner);
            });
        }

        // Handle app installation - Show custom notification
        window.addEventListener('appinstalled', (evt) => {            
            // Show custom success notification
            showSuccessNotification();
            
            // Track installation with PostHog
            if (window.posthog) {
                posthog.capture('pwa_installed');
            }
            
            // Remove install banner if it still exists
            const installBanner = document.getElementById('install-banner');
            if (installBanner) {
                document.body.removeChild(installBanner);
            }
        });

        function showSuccessNotification() {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #10b981;
                    color: white;
                    padding: 20px 30px;
                    border-radius: 10px;
                    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                    text-align: center;
                    max-width: 350px;
                    animation: slideDown 0.5s ease-out;
                ">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üéâ</div>
                    <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 5px;">
                        App Installed Successfully!
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">
                        You can now access PESU BCA from your home screen
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.5s ease-in';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 500);
            }, 4000);
        }

        // Add animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    transform: translate(-50%, -100%);
                    opacity: 0;
                }
                to {
                    transform: translate(-50%, 0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
    </body>

</html>
