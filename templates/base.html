{% import "macros/macros.html" as post_macros %}

<!DOCTYPE html>
<html lang="en" class="dark light">
<style>
    span {
        font-size: small;
    }

    mark {
        background-color: tomato;
        padding: 0.1em;
        border-radius: 0.125em;
    }

    /* Mobile-first responsive design */
    @media (max-width: 768px) {
        details summary {
            font-size: 1rem;
            padding: 6px;
        }

        .pdf-container iframe {
            height: 70vh;
        }
    }

    /* PWA-specific styles */
    @media (display-mode: standalone) {

        /* Hide browser UI elements when in PWA mode */
        .browser-only {
            display: none;
        }

        /* Add safe area for notched devices */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
    }

    /* Install banner animations */
    #install-banner {
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from {
            transform: translate(-50%, 100%);
            opacity: 0;
        }

        to {
            transform: translate(-50%, 0);
            opacity: 1;
        }
    }
</style>
{% include "partials/header.html" %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  try {
    if (window.posthog) {
    //   console.debug('posthog loaded, distinct_id=', posthog.get_distinct_id && posthog.get_distinct_id());
      const sessionData = sessionStorage.getItem('user_session');
      if (sessionData) {
        const session = JSON.parse(sessionData);
        if (session.srn) {
          posthog.identify(session.srn);
          posthog.register({
            srn: session.srn,
            name: session.profile?.name || null
          });
        }
      }
    //   try { posthog.capture('_debug_client_loaded'); }
    //   catch (e) { console.error('posthog.capture failed', e); }
    }
    else {
      console.warn('posthog not found on page (init script missing or blocked)');
    }
  } catch (e) {
    console.error('posthog identify failed', e);
  }
});
</script>

<body>
    <div class="left-content">
        {% block left_content %}
        {% endblock left_content %}
    </div>

    <div class="content">
        {% include "partials/nav.html" %}

        {# Post page is the default #}
        {% block main_content %}
        Nothing here?!
        {% endblock main_content %}

        {% if page.extra.comment is defined %}
        {% set show_comment = page.extra.comment %}
        {% else %}
        {% set show_comment = false %}
        {% endif %}

        {% if show_comment %}
        <div class="giscus"></div>
        {% include "_giscus_script.html" %}
        {% endif %}
        <footer>
            <div style="margin-bottom: 10px;">
                <a href="javascript:void(0)" onclick="showAnalyticsSettings()"
                    style="color: #4a90e2; text-decoration: underline;">Privacy Settings</a> |
                <a href="/privacy-policy" style="text-decoration: underline; color: #4a90e2;">Privacy Policy</a> |
                <a href="/terms-of-service" style="text-decoration: underline; color: #4a90e2;">Terms of Service</a>
            </div>
            <p>Built with ‚ù§Ô∏è using <mark><a href="https://getzola.org/"
                        style="text-decoration: underline;">Zola</a></mark> and <mark><a
                        href="https://www.getzola.org/themes/apollo/"
                        style="text-decoration: underline;">Apollo</a></mark></p>
            <span>&COPY; 2025 Anon</span>
        </footer>
    </div>

    <div class="right-content">
        {% block right_content %}
        {% endblock right_content %}
    </div>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Append a version query to bypass HTTP caches of sw.js
                const swVersion = '{{ config.extra.sw_version | default(value="0") }}';
                navigator.serviceWorker.register(`/sw.js?v=${swVersion}`, { scope: '/' })
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });

                // When the active controller changes (new SW takes control), reload once to pick up fresh assets
                let _reloadedForSW = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (_reloadedForSW) return;
                    _reloadedForSW = true;
                    try { window.location.reload(); } catch (e) { /* ignore */ }
                });
                
                        // Ask the service worker to refresh cached assets on every page load.
                        // This posts a message to the active controller (or waits until ready).
                        try {
                            if (navigator.serviceWorker.controller) {
                                // postMessage returns undefined; don't log its return value.
                                navigator.serviceWorker.controller.postMessage({ type: 'REFRESH_ON_LOAD' });
                                console.log('REFRESH_ON_LOAD message posted to active service worker');
                            } else {
                                // Wait until the service worker is ready (registration available)
                                navigator.serviceWorker.ready.then(() => {
                                    if (navigator.serviceWorker.controller) {
                                        navigator.serviceWorker.controller.postMessage({ type: 'REFRESH_ON_LOAD' });
                                        console.log('REFRESH_ON_LOAD message posted to service worker (on ready)');
                                    } else {
                                        console.log('No active service worker controller to receive REFRESH_ON_LOAD');
                                    }
                                }).catch((e) => console.warn('serviceWorker.ready failed', e));
                            }
                        } catch (e) { console.warn('REFRESH_ON_LOAD postMessage failed', e); }
            });
        }

                // Listen for messages from the service worker and log them to the page console
                if (navigator.serviceWorker) {
                    navigator.serviceWorker.addEventListener('message', (evt) => {
                        try {
                            const d = evt.data || {};
                            console.log('ServiceWorker -> page message:', d);
                            if (d && d.type === 'CACHE_REFRESHED') {
                                console.log(`[SW] CACHE_REFRESHED: refreshed ${d.refreshed}/${d.total} assets`);
                                // show a small non-blocking toast
                                // try {
                                //     const t = document.createElement('div');
                                //     t.textContent = `Updated ${d.refreshed}/${d.total} cached assets`;
                                //     t.style.position = 'fixed';
                                //     t.style.bottom = '12px';
                                //     t.style.right = '12px';
                                //     t.style.background = 'rgba(0,0,0,0.8)';
                                //     t.style.color = '#fff';
                                //     t.style.padding = '8px 12px';
                                //     t.style.borderRadius = '6px';
                                //     t.style.zIndex = 9999;
                                //     t.style.fontSize = '0.95rem';
                                //     document.body.appendChild(t);
                                //     setTimeout(() => { t.style.transition = 'opacity 300ms'; t.style.opacity = '0'; setTimeout(()=>t.remove(), 350); }, 3000);
                                // } catch (e) { /* ignore UI errors */ }
                            }
                        } catch (e) { console.warn('SW message handler error', e); }
                    });
                }

        // PWA Install Prompt
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;

            // Show install button/banner
            showInstallPrompt();
        });

        function showInstallPrompt() {
            // Create install banner
            const installBanner = document.createElement('div');
            installBanner.id = 'install-banner';
            installBanner.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #4a90e2;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 1000;
                    font-family: Arial, sans-serif;
                    text-align: center;
                    max-width: 300px;
                ">
                    <div style="margin-bottom: 10px;">üì± Install PESU BCA App</div>
                    <button id="install-button" style="
                        background: white;
                        color: #4a90e2;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 5px;
                        margin-right: 10px;
                        cursor: pointer;
                    ">Install</button>
                    <button id="dismiss-button" style="
                        background: transparent;
                        color: white;
                        border: 1px solid white;
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                    ">Later</button>
                </div>
            `;

            document.body.appendChild(installBanner);

            // Install button click
            document.getElementById('install-button').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        }
                        deferredPrompt = null;
                        document.body.removeChild(installBanner);
                    });
                }
            });

            // Dismiss button click
            document.getElementById('dismiss-button').addEventListener('click', () => {
                document.body.removeChild(installBanner);
            });
        }

        // Handle app installation - Show custom notification
        window.addEventListener('appinstalled', (evt) => {
            // Show custom success notification
            showSuccessNotification();

            // Track installation with PostHog
            if (window.posthog) {
                posthog.capture('pwa_installed');
            }

            // Remove install banner if it still exists
            const installBanner = document.getElementById('install-banner');
            if (installBanner) {
                document.body.removeChild(installBanner);
            }
        });

        function showSuccessNotification() {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #10b981;
                    color: white;
                    padding: 20px 30px;
                    border-radius: 10px;
                    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                    text-align: center;
                    max-width: 350px;
                    animation: slideDown 0.5s ease-out;
                ">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üéâ</div>
                    <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 5px;">
                        App Installed Successfully!
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">
                        You can now access PESU BCA from your home screen
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.5s ease-in';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 500);
            }, 4000);
        }

        // Add animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    transform: translate(-50%, -100%);
                    opacity: 0;
                }
                to {
                    transform: translate(-50%, 0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
    <script>
        (function () {
            const DB_NAME = 'res_index';
            const DB_VERSION = 1.1;
            const DEBUG = eval(window.location.hostname === 'pes-bca.pages.dev');
            let ready = false;

            const log  = (...a) => { if (DEBUG) console.debug('[res-indexer]', ...a); };
            const warn = (...a) => { if (DEBUG) console.warn('[res-indexer]', ...a); };
            const err  = (...a) => { console.error('[res-indexer]', ...a); }; // keep actual errors visible

            function openDB() {
                return new Promise((resolve, reject) => {
                    try {
                        const req = indexedDB.open(DB_NAME, DB_VERSION);
                        req.onupgradeneeded = e => {
                            const db = e.target.result;
                            if (!db.objectStoreNames.contains('resources')) {
                                const os = db.createObjectStore('resources', { keyPath: 'path' });
                                os.createIndex('by-added', 'addedAt');
                                log('DB upgraded: created objectStore resources');
                            }
                        };
                        req.onsuccess = e => { ready = true; log('DB opened'); resolve(e.target.result); };
                        req.onerror = e => { err('indexedDB open error', e.target.error); reject(e.target.error); };
                    } catch (e) { err('openDB exception', e); reject(e); }
                });
            }

            async function putResource(r) {
                try {
                    const db = await openDB();
                    return new Promise((res, rej) => {
                        const tx = db.transaction('resources', 'readwrite');
                        const store = tx.objectStore('resources');
                        store.put({ path: r.path, title: r.title || '', addedAt: r.addedAt || Date.now() });
                        tx.oncomplete = () => res();
                        tx.onerror = ev => { err('putResource tx error', ev.target.error); rej(ev.target.error); };
                    });
                } catch (e) { err('putResource error', e); throw e; }
            }

            function normalizeLink(href) {
                try {
                    const u = new URL(href, location.origin);
                    if (u.pathname.startsWith('/pdf-viewer')) {
                        const p = u.searchParams.get('file') || '';
                        if (!p) return null;
                        const dp = decodeURIComponent(p);
                        return dp.startsWith('/') ? dp.replace(/\/+$/, '') : '/' + dp.replace(/\/+$/, '');
                    }
                    if (u.pathname.includes('/static/')) {
                        const p = u.pathname.replace('/static/', '/');
                        return decodeURIComponent(p).replace(/\/+$/, '');
                    }
                    return null;
                } catch { return null; }
            }

            async function indexAllLinks() {
                if (!('indexedDB' in window)) {
                    warn('IndexedDB not available');
                    return;
                }
                const anchors = Array.from(document.querySelectorAll('a[href]'));
                let added = 0;
                for (const a of anchors) {
                    const p = normalizeLink(a.href);
                    if (p) {
                        try { await putResource({ path: p, title: (a.innerText || a.title || p.split('/').pop()), addedAt: Date.now() }); added++; }
                        catch (e) { warn('failed to put', p, e); }
                    }
                }
                if (DEBUG) log('indexAllLinks done, added:', added);
            }

            async function dumpIndexedResources() {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('resources', 'readonly');
                    const store = tx.objectStore('resources');
                    const out = [];
                    const req = store.openCursor();
                    req.onsuccess = ev => {
                        const cur = ev.target.result;
                        if (!cur) return resolve(out);
                        out.push(cur.value);
                        cur.continue();
                    };
                    req.onerror = ev => reject(ev.target.error);
                });
            }

            window.indexAllLinks = indexAllLinks;
            window.putResource = putResource;
            window.dumpIndexedResources = dumpIndexedResources;

            document.addEventListener('DOMContentLoaded', () => { indexAllLinks().catch(err); });

            const mo = new MutationObserver(() => {
                clearTimeout(window._pes_indexer_timer);
                window._pes_indexer_timer = setTimeout(() => { indexAllLinks().catch(err); }, 250);
            });
            mo.observe(document.body, { childList: true, subtree: true });

            // Expose helper to query resources by prefix
            async function getResourcesWithPrefix(prefix) {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('resources', 'readonly');
                    const store = tx.objectStore('resources');
                    const out = [];
                    const req = store.openCursor();
                    req.onsuccess = evt => {
                        const cur = evt.target.result;
                        if (!cur) return resolve(out);
                        const p = cur.value.path;
                        if (p.startsWith(prefix)) out.push(cur.value);
                        cur.continue();
                    };
                    req.onerror = ev => reject(ev.target.error);
                });
            }
        })
    </script>
</body>

</html>